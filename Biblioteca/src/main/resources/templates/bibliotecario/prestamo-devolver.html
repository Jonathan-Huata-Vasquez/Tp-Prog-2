<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head(titulo='Registrar devolución - Bibliotecario')}">
    <title>Registrar devolución - Bibliotecario</title>
    <link rel="stylesheet" th:href="@{/css/biblioteca-common.css}">
    <link rel="stylesheet" th:href="@{/css/prestamos.css}">
</head>

<body>

    <!-- Navbar fragment -->
    <div th:replace="~{fragments/navbar-bibliotecario :: navbarBibliotecario('prestamos')}"></div>

    <main class="container">
        <div class="row g-4 mt-4">

            <!-- Encabezado -->
            <div class="col-12">
                <div class="card card-soft mb-3">
                    <div
                        class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                        <div>
                            <p class="section-title mb-1">Préstamos</p>
                            <h1 class="h4 mb-2">
                                Registrar devolución de préstamo
                            </h1>
                            <p class="mb-0 text-soft-muted">
                                Indicá el ID del préstamo que querés marcar como devuelto. El sistema actualizará el
                                estado y liberará el ejemplar según las reglas de dominio.
                            </p>
                        </div>
                        <div class="text-md-end">
                            <p class="small-label mb-1">Recordatorio</p>
                            <p class="small text-soft-muted mb-0">
                                Los días de atraso impactan en la penalización del lector (días × 2).
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario + resumen préstamo -->
            <div class="col-lg-8">
                <div class="card card-soft mb-3">
                    <div class="card-body">
                        <p class="section-title mb-3">Datos para la devolución</p>

                        <!-- FORM -->
                                                <form th:action="@{/bibliotecario/prestamos/devolver}" method="post"
                                                            th:object="${devolverCopiaCommand}" class="row g-3">
                                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                            <!-- ID PRÉSTAMO -->
                            <div class="col-12 col-md-6">
                                <label for="idPrestamo" class="small-label mb-1">ID del préstamo</label>
                                <input type="number" id="idLector" class="form-control" th:field="*{idLector}" placeholder="ID lector" required />
                                <div class="form-text text-soft-muted mt-1 small">ID del lector que hizo el préstamo.</div>
                            </div>

                            <div class="col-12 col-md-6">
                                <label for="idCopia" class="small-label mb-1">ID de la copia</label>
                                <input type="number" id="idCopia" class="form-control" th:field="*{idCopia}" placeholder="ID copia" required />
                                <div class="form-text text-soft-muted mt-1 small">
                                    ID del ejemplar prestado (lo ves en listado o detalle lector).
                                </div>
                            </div>

                            <!-- Fecha devolución (informativa) -->
                            <div class="col-12 col-md-6">
                                <label for="enviarAReparacion" class="small-label mb-1">Enviar a reparación</label>
                                <select id="enviarAReparacion" class="form-control" th:field="*{enviarAReparacion}">
                                    <option th:value="false" selected>No</option>
                                    <option th:value="true">Sí</option>
                                </select>
                                <div class="form-text text-soft-muted mt-1 small">Elegí "Sí" si la copia vuelve dañada.</div>
                            </div>

                            <div class="divider-soft"></div>

                            <!-- Botones -->
                            <div class="col-12 d-flex flex-wrap gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>
                                    Confirmar devolución
                                </button>

                                <a th:href="@{/bibliotecario/prestamos}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-1"></i>
                                    Cancelar y volver al listado
                                </a>
                                <!-- Thymeleaf: th:href="@{/bibliotecario/prestamos}" -->
                            </div>

                            <!-- Mensajes de error/validación (opcional)
                             Thymeleaf:
                             <div class="col-12 mt-2" th:if="${#fields.hasErrors('*')}">
                                 <p class="small text-danger mb-0" th:errors="*{idPrestamo}">
                                     Error en el ID de préstamo
                                 </p>
                             </div>
                        -->
                        </form>
                    </div>
                </div>

                <!-- Resumen del préstamo (solo lectura, opcional si backend trae datos) -->
                <div class="card card-soft-light" th:if="${mensajeError != null or mensajeExito != null}">
                    <div class="card-body">
                        <p class="section-title mb-2">Estado de la operación</p>
                        <div th:if="${mensajeExito}" class="alert alert-success mb-2">
                            <i class="bi bi-check-circle-fill me-1"></i>
                            <span th:text="${mensajeExito}">Devolución OK</span>
                        </div>
                        <div th:if="${mensajeError}" class="alert alert-danger mb-2">
                            <i class="bi bi-x-circle-fill me-1"></i>
                            <span th:text="${mensajeError}">Error</span>
                        </div>

                        <!-- Ejemplo estático -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <p class="small-label mb-1">Lector</p>
                                <h2 class="h6 mb-1">
                                    Juan Pérez
                                    <!-- Thymeleaf: th:text="${prestamo?.nombreLector}" -->
                                </h2>
                                <p class="small text-soft-muted mb-1">
                                    ID lector: 102
                                    <!-- Thymeleaf:
                                     <span th:text="${prestamo?.idLector}">102</span>
                                -->
                                </p>
                                <p class="small mb-0">
                                    Estado lector:
                                    <span class="text-soft-muted">
                                        Habilitado
                                        <!-- Thymeleaf:
                                         <span th:if="${!prestamo?.lectorBloqueado}">Habilitado</span>
                                         <span th:if="${prestamo?.lectorBloqueado}">Bloqueado</span>
                                    -->
                                    </span>
                                </p>
                            </div>

                            <div class="col-md-6">
                                <p class="small-label mb-1">Libro y ejemplar</p>
                                <h2 class="h6 mb-1">
                                    Cien años de soledad
                                    <!-- Thymeleaf: th:text="${prestamo?.tituloLibro}" -->
                                </h2>
                                <p class="small text-soft-muted mb-1">
                                    Ejemplar: #145
                                    <!-- Thymeleaf:
                                     <span th:text="${prestamo?.idEjemplar}">145</span>
                                -->
                                </p>
                                <p class="small mb-0">
                                    Estado actual:
                                    <span class="badge-estado badge-estado-vencido">
                                        Vencido
                                    </span>
                                    <!-- Thymeleaf:
                                     <span th:switch="${prestamo?.estado}">
                                         <span th:case="'ACTIVO'"   class="badge-estado badge-estado-activo">Activo</span>
                                         <span th:case="'VENCIDO'"  class="badge-estado badge-estado-vencido">Vencido</span>
                                         <span th:case="'DEVUELTO'" class="badge-estado badge-estado-devuelto">Devuelto</span>
                                     </span>
                                -->
                                </p>
                            </div>
                        </div>

                        <div class="divider-soft"></div>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <p class="small-label mb-1">Fecha préstamo</p>
                                <p class="mb-0">
                                    01/09/2025
                                    <!-- Thymeleaf: th:text="${prestamo?.fechaPrestamo}" -->
                                </p>
                            </div>
                            <div class="col-md-4">
                                <p class="small-label mb-1">Fecha vencimiento</p>
                                <p class="mb-0">
                                    22/09/2025
                                    <!-- Thymeleaf: th:text="${prestamo?.fechaVencimiento}" -->
                                </p>
                            </div>
                            <div class="col-md-4">
                                <p class="small-label mb-1">Días de atraso</p>
                                <p class="highlight-number mb-0" style="font-size: 1.4rem;">
                                    15
                                    <!-- Thymeleaf: th:text="${prestamo?.diasAtraso}" -->
                                </p>
                            </div>
                        </div>

                        <div class="divider-soft"></div>

                        <p class="small text-soft-muted mb-0">
                            La penalización correspondiente (días de atraso × 2) se aplica en el dominio al lector una
                            vez registrada la devolución.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: reglas + navegación -->
            <div class="col-lg-4">
                <div class="card card-soft-light mb-3">
                    <div class="card-body">
                        <p class="section-title mb-2">Reglas del dominio</p>
                        <ul class="list-unstyled small mb-0 text-soft-muted">
                            <li>• Máximo 5 préstamos activos por lector.</li>
                            <li>• Cada préstamo vence a los 21 días desde su creación.</li>
                            <li>• Si hay atraso, el lector queda no elegible hasta cumplir penalización (días de atraso × 2).</li>
                            <li>• Un ejemplar no puede estar prestado dos veces al mismo tiempo.</li>
                            <li>• La devolución libera el ejemplar para futuros préstamos.</li>
                        </ul>
                    </div>
                </div>

                <div class="card card-soft-light">
                    <div class="card-body">
                        <p class="section-title mb-2">Navegación</p>
                        <div class="d-grid gap-2">
                            <a th:href="@{/dashboard/bibliotecario}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-speedometer2 me-1"></i>
                                Panel de bibliotecario
                            </a>
                            <a th:href="@{/bibliotecario/prestamos}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-journal-text me-1"></i>
                                Listado de préstamos
                            </a>
                            <a th:href="@{/bibliotecario/lectores}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-people me-1"></i>
                                Listado de lectores
                            </a>
                            <a th:href="@{/catalogo}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-book-half me-1"></i>
                                Catálogo de libros
                            </a>
                        </div>
                    </div>
                </div>
            </div>