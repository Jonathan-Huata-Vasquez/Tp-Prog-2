<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head(titulo='Registrar devolución - Bibliotecario')}">
    <title>Registrar devolución - Bibliotecario</title>
    <link rel="stylesheet" th:href="@{/css/biblioteca-common.css}">
    <link rel="stylesheet" th:href="@{/css/prestamos.css}">
</head>

<body>

    <!-- Navbar fragment -->
    <div th:replace="~{fragments/navbar-bibliotecario :: navbarBibliotecario('prestamos')}"></div>

    <main class="container">
        <div class="row g-4 mt-4">

            <!-- Encabezado -->
            <div class="col-12">
                <div class="card card-soft mb-3">
                    <div
                        class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                        <div>
                            <p class="section-title mb-1">Préstamos</p>
                            <h1 class="h4 mb-2">
                                Registrar devolución de préstamo
                            </h1>
                            <p class="mb-0 text-soft-muted">
                                Indicá el ID del préstamo que querés marcar como devuelto. El sistema actualizará el
                                estado y liberará el ejemplar según las reglas de dominio.
                            </p>
                        </div>
                        <div class="text-md-end">
                            <p class="small-label mb-1">Recordatorio</p>
                            <p class="small text-soft-muted mb-0">
                                Los días de atraso impactan en la penalización del lector (días × 2).
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario + resumen préstamo -->
            <div class="col-lg-8">
                <div class="card card-soft mb-3">
                    <div class="card-body">
                        <p class="section-title mb-3">Datos para la devolución</p>

                        <!-- FORM principal devolución -->
                        <form th:action="@{/bibliotecario/prestamos/devolver}" method="post"
                              th:object="${devolverCopiaCommand}" class="row g-3">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                            <!-- ID LECTOR -->
                            <div class="col-12 col-md-6">
                                <label for="idLector" class="small-label mb-1">ID del lector</label>
                                <div th:if="${!validadoDevolucion}">
                                    <input type="number" id="idLector" class="form-control" th:field="*{idLector}" placeholder="Ej: 102" required />
                                </div>
                                <div th:if="${validadoDevolucion}">
                                    <input type="number" class="form-control" th:field="*{idLector}" readonly />
                                </div>
                                <div class="form-text text-soft-muted mt-1 small">Ingresá el identificador del lector.</div>
                            </div>

                            <!-- ID COPIA -->
                            <div class="col-12 col-md-6">
                                <label for="idCopia" class="small-label mb-1">ID de la copia</label>
                                <div th:if="${!validadoDevolucion}">
                                    <input type="number" id="idCopia" class="form-control" th:field="*{idCopia}" placeholder="Ej: 145" required />
                                </div>
                                <div th:if="${validadoDevolucion}">
                                    <input type="number" class="form-control" th:field="*{idCopia}" readonly />
                                </div>
                                <div class="form-text text-soft-muted mt-1 small">Ingresá el identificador del ejemplar.</div>
                            </div>

                            <!-- Enviar a reparación -->
                            <div class="col-12 col-md-6">
                                <label for="enviarAReparacion" class="small-label mb-1">Enviar a reparación</label>
                                <select id="enviarAReparacion" class="form-control"
                                        th:field="*{enviarAReparacion}"
                                        th:disabled="${!validadoDevolucion || !puedeDevolver || resumenPrestamo == null}">
                                    <option th:value="false" th:selected="${true}">No</option>
                                    <option th:value="true">Sí</option>
                                </select>
                                <input type="hidden" name="enviarAReparacion" value="false"
                                       th:if="${!validadoDevolucion || !puedeDevolver || resumenPrestamo == null}" />
                                <div class="form-text text-soft-muted mt-1 small">Disponible solo cuando existe préstamo activo/vencido.</div>
                            </div>

                            <div class="divider-soft"></div>

                            <!-- Botones -->
                            <div class="col-12 d-flex flex-wrap gap-2">
                                <!-- Confirmar devolución (solo luego de validar y si puedeDevolver) -->
                                <button type="submit" class="btn btn-primary"
                                        th:disabled="${!validadoDevolucion || !puedeDevolver}"
                                        th:classappend="${!validadoDevolucion || !puedeDevolver} ? 'disabled' : ''">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>
                                    Confirmar devolución
                                </button>

                                <!-- Botón Validar -->
                                <button type="submit" th:if="${!validadoDevolucion}" class="btn btn-success"
                                        formaction="/bibliotecario/prestamos/devolver/validar" formmethod="post">
                                    <i class="bi bi-check-circle me-1"></i>
                                    Validar datos
                                </button>

                                <!-- Botón Resetear -->
                                <button type="submit" th:if="${validadoDevolucion}" class="btn btn-warning"
                                        formaction="/bibliotecario/prestamos/devolver/resetear" formmethod="post">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>
                                    Resetear
                                </button>

                                <a th:href="@{/bibliotecario/prestamos}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-1"></i>
                                    Cancelar y volver al listado
                                </a>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Resumen del préstamo (solo lectura, opcional si backend trae datos) -->
                <div class="card card-soft-light" th:if="${validadoDevolucion}">
                    <div class="card-body">
                        <p class="section-title mb-2">Resultado de la validación</p>

                        <div th:if="${puedeDevolver}" class="alert alert-success">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Datos válidos. Puede proceder a registrar la devolución.
                        </div>
                        <div th:if="${!puedeDevolver}" class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            No puede devolver: revise el estado del préstamo.
                        </div>
                        <div th:if="${mensajeError}" class="alert alert-danger">
                            <i class="bi bi-x-circle-fill me-2"></i>
                            <span th:text="${mensajeError}">Error</span>
                        </div>

                        <div class="row g-3" th:if="${resumenPrestamo}">
                            <div class="col-md-6">
                                <p class="small-label mb-1">Lector</p>
                                <h2 class="h6 mb-1" th:text="${resumenPrestamo.nombreLector}">Nombre Lector</h2>
                                <p class="small text-soft-muted mb-1">
                                    <span th:text="${'ID: ' + resumenPrestamo.idLector}">ID: 0</span>
                                </p>
                                <p class="small mb-0">
                                    Estado lector:
                                    <span th:if="${resumenPrestamo.lectorBloqueado}" class="text-danger">
                                        <i class="bi bi-x-circle"></i> Bloqueado
                                    </span>
                                    <span th:if="${!resumenPrestamo.lectorBloqueado}" class="text-success">
                                        <i class="bi bi-check-circle"></i> Habilitado
                                    </span>
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p class="small-label mb-1">Libro y ejemplar</p>
                                <h2 class="h6 mb-1" th:text="${resumenPrestamo.tituloLibro}">Título</h2>
                                <p class="small text-soft-muted mb-1">
                                    <span th:text="${'Autor: ' + resumenPrestamo.autorNombre}">Autor</span>
                                </p>
                                <p class="small mb-0">
                                    Ejemplar:
                                    <span th:text="${'#' + resumenPrestamo.idCopia}">#0</span>
                                </p>
                            </div>
                        </div>

                        <div class="divider-soft" th:if="${resumenPrestamo}"></div>

                        <div class="row g-3" th:if="${resumenPrestamo}">
                            <div class="col-md-4">
                                <p class="small-label mb-1">Fecha préstamo</p>
                                <p class="mb-0" th:text="${#temporals.format(resumenPrestamo.fechaInicio,'dd/MM/yyyy')}">01/01/2025</p>
                            </div>
                            <div class="col-md-4">
                                <p class="small-label mb-1">Fecha vencimiento</p>
                                <p class="mb-0" th:text="${#temporals.format(resumenPrestamo.fechaVencimiento,'dd/MM/yyyy')}">21/01/2025</p>
                            </div>
                            <div class="col-md-4">
                                <p class="small-label mb-1">Días de atraso</p>
                                <p class="highlight-number mb-0" style="font-size:1.4rem;" th:text="${resumenPrestamo.diasAtraso}">0</p>
                            </div>
                        </div>

                        <div class="divider-soft" th:if="${resumenPrestamo}"></div>

                        <p class="small text-soft-muted mb-0" th:if="${resumenPrestamo}">
                            La penalización (días atraso × 2) se aplicará al cerrar la devolución.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: reglas + navegación -->
            <div class="col-lg-4">
                <div class="card card-soft-light mb-3">
                    <div class="card-body">
                        <p class="section-title mb-2">Reglas del dominio</p>
                        <ul class="list-unstyled small mb-0 text-soft-muted">
                            <li>• Máximo 5 préstamos activos por lector.</li>
                            <li>• Cada préstamo vence a los 21 días desde su creación.</li>
                            <li>• Si hay atraso, el lector queda no elegible hasta cumplir penalización (días de atraso × 2).</li>
                            <li>• Un ejemplar no puede estar prestado dos veces al mismo tiempo.</li>
                            <li>• La devolución libera el ejemplar para futuros préstamos.</li>
                            <li>• Solo se puede devolver si el préstamo está activo o vencido (no devuelto).</li>
                        </ul>
                    </div>
                </div>

                <div class="card card-soft-light">
                    <div class="card-body">
                        <p class="section-title mb-2">Navegación</p>
                        <div class="d-grid gap-2">
                            <a th:href="@{/dashboard/bibliotecario}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-speedometer2 me-1"></i>
                                Panel de bibliotecario
                            </a>
                            <a th:href="@{/bibliotecario/prestamos}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-journal-text me-1"></i>
                                Listado de préstamos
                            </a>
                            <a th:href="@{/bibliotecario/lectores}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-people me-1"></i>
                                Listado de lectores
                            </a>
                            <a th:href="@{/catalogo}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-book-half me-1"></i>
                                Catálogo de libros
                            </a>
                        </div>
                    </div>
                </div>
            </div>