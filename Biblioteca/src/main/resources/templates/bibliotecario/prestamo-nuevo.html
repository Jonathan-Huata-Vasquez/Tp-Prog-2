<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head(titulo='Registrar préstamo - Bibliotecario')}">
    <title>Registrar préstamo - Bibliotecario</title>
    <!-- CSS común para toda la biblioteca -->
    <link rel="stylesheet" th:href="@{/css/biblioteca-common.css}">
    <!-- CSS específico para préstamos -->
    <link rel="stylesheet" th:href="@{/css/prestamos.css}">

    <style>
        .alert {
            border-radius: 0.75rem;
            border: none;
            font-size: 0.9rem;
        }

        .alert-success {
            background-color: rgba(34, 197, 94, 0.1);
            color: #16a34a;
        }

        .alert-warning {
            background-color: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .alert-danger {
            background-color: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        .badge {
            font-size: 0.7rem;
        }
    </style>
</head>

<body>

    <!-- Navbar fragment reutilizable -->
    <div th:replace="~{fragments/navbar-bibliotecario :: navbarBibliotecario('prestamos')}"></div>

    <main class="container">
        <div class="row g-4 mt-4">

            <!-- Encabezado -->
            <div class="col-12">
                <div class="card card-soft mb-3">
                    <div
                        class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                        <div>
                            <p class="section-title mb-1">Préstamos</p>
                            <h1 class="h4 mb-2">
                                Registrar nuevo préstamo
                            </h1>
                            <p class="mb-0 text-soft-muted">
                                Completá el lector y el ejemplar que se va a prestar. La fecha de vencimiento se calcula
                                a los 21 días.
                            </p>
                        </div>
                        <div class="text-md-end">
                            <p class="small-label mb-1">Reglas</p>
                            <p class="small text-soft-muted mb-0">
                                Máx. 5 préstamos activos por lector · 21 días por préstamo.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario + resumen -->
            <div class="col-lg-8">
                <div class="card card-soft mb-3">
                    <div class="card-body">
                        <p class="section-title mb-3">Datos del préstamo</p>

                        <!-- FORM -->
                        <form th:action="@{/bibliotecario/prestamos}" method="post"
                            th:object="${registrarPrestamoCommand}" class="row g-3">

                            <!-- ID LECTOR -->
                            <div class="col-12 col-md-6">
                                <label for="idLector" class="small-label mb-1">ID del lector</label>
                                <!-- Modo edición antes de validar -->
                                <div th:if="${!validado}">
                                    <input type="number" id="idLector" class="form-control" th:field="*{idLector}"
                                        placeholder="Ej: 102" required />
                                </div>
                                <!-- Modo solo lectura después de validar -->
                                <div th:if="${validado}">
                                    <input type="number" class="form-control"
                                        th:value="${registrarPrestamoCommand.idLector}" readonly />
                                </div>
                                <div class="form-text text-soft-muted mt-1 small">
                                    Ingresá el identificador del lector. Podés obtenerlo desde "Lectores".
                                </div>
                            </div>

                            <!-- ID EJEMPLAR -->
                            <div class="col-12 col-md-6">
                                <label for="idCopia" class="small-label mb-1">ID del ejemplar</label>
                                <!-- Modo edición antes de validar -->
                                <div th:if="${!validado}">
                                    <input type="number" id="idCopia" class="form-control" th:field="*{idCopia}"
                                        placeholder="Ej: 145" required />
                                </div>
                                <!-- Modo solo lectura después de validar -->
                                <div th:if="${validado}">
                                    <input type="number" class="form-control"
                                        th:value="${registrarPrestamoCommand.idCopia}" readonly />
                                </div>
                                <div class="form-text text-soft-muted mt-1 small">
                                    Ingresá el identificador del ejemplar que se va a prestar.
                                </div>
                            </div>

                            <div class="divider-soft"></div>

                            <!-- Fechas (solo informativo) -->
                            <div class="col-12 col-md-4">
                                <p class="small-label mb-1">Fecha de préstamo (hoy)</p>
                                <p class="mb-0">
                                    <span th:text="${fechaHoy}">20/10/2025</span>
                                </p>
                            </div>
                            <div class="col-12 col-md-4">
                                <p class="small-label mb-1">Fecha de vencimiento (estimada)</p>
                                <p class="mb-0">
                                    <span th:text="${fechaVencimiento}">10/11/2025</span>
                                    <!-- (21 días después de fechaHoy calculado en dominio) -->
                                </p>
                            </div>
                            <div class="col-12 col-md-4">
                                <p class="small-label mb-1">Estado inicial</p>
                                <p class="mb-0">
                                    <span class="badge-estado badge-estado-activo">
                                        Activo
                                    </span>
                                </p>
                            </div>

                            <div class="divider-soft"></div>

                            <div class="col-12 d-flex flex-wrap gap-2">

                                <!-- Botón Registrar préstamo (habilitado solo después de validar) -->
                                <button type="submit" class="btn btn-primary" th:disabled="${!puedeRegistrar}"
                                    th:classappend="${!puedeRegistrar} ? 'disabled' : ''">
                                    <i class="bi bi-check2-circle me-1"></i>
                                    Registrar préstamo
                                </button>

                                <!-- Botón Validar datos (envía los campos al endpoint de validación) -->
                                <button type="submit" th:if="${!validado}" class="btn btn-success"
                                    formaction="/bibliotecario/prestamos/validar" formmethod="post">
                                    <i class="bi bi-check-circle me-1"></i>
                                    Validar datos
                                </button>

                                <!-- Botón Resetear (ocupa lugar del Validar una vez validado) -->
                                <button type="submit" th:if="${validado}" class="btn btn-warning"
                                    formaction="/bibliotecario/prestamos/resetear" formmethod="post">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>
                                    Resetear
                                </button>

                                <a th:href="@{/bibliotecario/prestamos}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-1"></i>
                                    Cancelar y volver al listado
                                </a>
                            </div>
                        </form>

                        <!-- Botón resetear movido al grupo principal de botones -->
                    </div>
                </div>

                <!-- Resumen dinámico (mostrar solo después de validar) -->
                <div class="card card-soft-light" th:if="${validado}">
                    <div class="card-body">
                        <p class="section-title mb-2">Resultado de la validación</p>

                        <!-- Mensaje de estado general -->
                        <div th:if="${puedeRegistrar}" class="alert alert-success">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            Los datos son válidos. Puede proceder a registrar el préstamo.
                        </div>

                        <div th:if="${!puedeRegistrar}" class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Hay problemas con los datos ingresados. Revise la información a continuación.
                        </div>

                        <!-- Mensaje de error si existe -->
                        <div th:if="${mensajeError}" class="alert alert-danger">
                            <i class="bi bi-x-circle-fill me-2"></i>
                            <span th:text="${mensajeError}">Error mensaje</span>
                        </div>

                        <div class="row g-3">
                            <!-- Resumen lector -->
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <p class="small-label mb-0 me-2">Lector</p>
                                    <span th:if="${lectorValido}" class="badge bg-success">
                                        <i class="bi bi-check-lg"></i> Válido
                                    </span>
                                    <span th:if="${!lectorValido}" class="badge bg-danger">
                                        <i class="bi bi-x-lg"></i> No válido
                                    </span>
                                </div>

                                <div th:if="${resumenLector}">
                                    <h2 class="h6 mb-1">
                                        <span th:text="${resumenLector.nombre}">Juan Pérez</span>
                                    </h2>
                                    <p class="small text-soft-muted mb-1">
                                        <span
                                            th:text="${'ID: ' + resumenLector.id + ' · Préstamos activos: ' + resumenLector.prestamosActivos + ' / 5'}">ID:
                                            102 · Préstamos activos: 3 / 5</span>
                                    </p>
                                    <p class="small mb-0">
                                        Estado:
                                        <span th:if="${!resumenLector.bloqueado}" class="text-success">
                                            <i class="bi bi-check-circle"></i> Habilitado
                                        </span>
                                        <span th:if="${resumenLector.bloqueado}" class="text-danger">
                                            <i class="bi bi-x-circle"></i> Bloqueado
                                        </span>
                                    </p>
                                </div>

                                <div th:if="${resumenLector == null}" class="text-muted small">
                                    <i class="bi bi-exclamation-triangle"></i> Lector no encontrado
                                </div>
                            </div>

                            <!-- Resumen ejemplar -->
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <p class="small-label mb-0 me-2">Ejemplar</p>
                                    <span th:if="${copiaValida}" class="badge bg-success">
                                        <i class="bi bi-check-lg"></i> Válido
                                    </span>
                                    <span th:if="${!copiaValida}" class="badge bg-danger">
                                        <i class="bi bi-x-lg"></i> No válido
                                    </span>
                                </div>

                                <div th:if="${resumenEjemplar}">
                                    <h2 class="h6 mb-1">
                                        <span th:text="${resumenEjemplar.tituloLibro}">Cien años de soledad</span>
                                    </h2>
                                    <p class="small text-soft-muted mb-1">
                                        <span th:text="${'Autor: ' + resumenEjemplar.autor}">Autor: Gabriel García
                                            Márquez</span>
                                    </p>
                                    <p class="small mb-0">
                                        Ejemplar:
                                        <span th:text="${'#' + resumenEjemplar.idEjemplar}">#145</span>
                                        <span th:if="${resumenEjemplar.disponible}" class="text-success">
                                            <i class="bi bi-check-circle"></i> Disponible
                                        </span>
                                        <span th:if="${!resumenEjemplar.disponible}" class="text-danger">
                                            <i class="bi bi-x-circle"></i> No disponible
                                        </span>
                                    </p>
                                </div>

                                <div th:if="${resumenEjemplar == null}" class="text-muted small">
                                    <i class="bi bi-exclamation-triangle"></i> Ejemplar no encontrado
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: recordatorios (estilo original restaurado) -->
            <div class="col-lg-4">
                <div class="card card-soft-light mb-3">
                    <div class="card-body">
                        <p class="section-title mb-2">Recordatorios del dominio</p>
                        <ul class="list-unstyled small mb-0 text-soft-muted">
                            <li>• Un lector puede tener como máximo 5 préstamos activos.</li>
                            <li>• Cada préstamo vence a los 21 días desde su creación.</li>
                            <li>• Si hay atraso, el lector queda no elegible hasta cumplir penalización (días de atraso
                                ×
                                2).</li>
                            <li>• Un ejemplar no puede estar prestado dos veces al mismo tiempo.</li>
                            <li>• La validación de estas reglas se hace en el dominio, no en la vista.</li>
                        </ul>
                    </div>
                </div>

                <div class="card card-soft-light">
                    <div class="card-body">
                        <p class="section-title mb-2">Navegación</p>
                        <div class="d-grid gap-2">
                            <a th:href="@{/dashboard/bibliotecario}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-speedometer2 me-1"></i>
                                Panel de bibliotecario
                            </a>
                            <a th:href="@{/bibliotecario/prestamos}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-journal-text me-1"></i>
                                Listado de préstamos
                            </a>
                            <a th:href="@{/bibliotecario/lectores}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-people me-1"></i>
                                Listado de lectores
                            </a>
                            <a th:href="@{/catalogo}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-book-half me-1"></i>
                                Catálogo de libros
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        </div>
    </main>

</body>

</html>