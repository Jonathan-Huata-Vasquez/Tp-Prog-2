<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: head(titulo='Lectores - Bibliotecario')}"></head>
<link rel="stylesheet" th:href="@{/css/lectores.css}">

<body>
    <!-- Navbar dinámico -->
    <div th:replace="~{fragments/navbar-bibliotecario :: navbarBibliotecario('lectores')}"></div>

    <main class="container">
        <div class="row g-4 mt-4">

            <!-- Encabezado -->
            <div class="col-12">
                <div class="card card-soft mb-3">
                    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                        <div>
                            <p class="section-title mb-1">Lectores</p>
                            <h1 class="h4 mb-2">
                                Listado de lectores
                            </h1>
                            <p class="mb-0 text-soft-muted">
                                Consulta de todos los lectores registrados, su estado de elegibilidad y cantidad de préstamos.
                            </p>
                        </div>
                        <div class="text-md-end">
                            <p class="small-label mb-1">Resumen</p>
                            <p class="mb-1">
                                <span class="highlight-number" style="font-size: 1.4rem;" th:text="${resumen?.totalLectores ?: 0}">
                                    0
                                </span>
                                <span class="small text-soft-muted ms-1">
                                    lectores en el sistema
                                </span>
                            </p>
                            <p class="mb-0">
                                <span class="badge-estado badge-estado-activo me-1" th:text="${resumen?.habilitados ?: 0} + ' habilitados'">
                                    0 habilitados
                                </span>
                                <span class="badge-bloqueado" th:text="${resumen?.bloqueados ?: 0} + ' bloqueados'">
                                    0 bloqueados
                                </span>
                            </p>
                            <a th:href="@{/dashboard/bibliotecario}" class="btn btn-outline-secondary btn-sm mt-2">
                                <i class="bi bi-arrow-left me-1"></i>
                                Volver al panel
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de lectores (sin paginación) -->
            <div class="col-12">
                <div class="card card-soft">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <p class="section-title mb-1">Listado completo</p>
                                <p class="small text-soft-muted mb-0">
                                    Mostrando página <span th:text="${paginaLectores?.numeroPagina != null ? paginaLectores.numeroPagina + 1 : 1}">1</span> 
                                    de <span th:text="${paginaLectores?.totalPaginas ?: 1}">1</span> 
                                    (<span th:text="${paginaLectores?.totalElementos ?: resumen?.totalLectores ?: 0}">0</span> lectores en total)
                                </p>
                            </div>
                            <div class="text-end">
                                <!-- Filtros de estado -->
                                <form method="get" class="d-inline-block me-3 estado-filter">
                                    <div class="input-group input-group-sm">
                                        <select name="estado" class="form-select" onchange="this.form.submit()">
                                            <option value="">Todos los estados</option>
                                            <option value="HABILITADO" th:selected="${estadoFiltro == 'HABILITADO'}">Solo habilitados</option>
                                            <option value="BLOQUEADO" th:selected="${estadoFiltro == 'BLOQUEADO'}">Solo bloqueados</option>
                                        </select>
                                        <input type="hidden" name="pagina" th:value="0">
                                        <input type="hidden" name="tamano" th:value="${paginaLectores?.tamanoPagina ?: 20}">
                                    </div>
                                </form>
                                
                                <div class="d-inline-block">
                                    <p class="small-label mb-1">Leyenda de estado</p>
                                    <div class="d-flex flex-wrap gap-2 justify-content-end">
                                        <span class="badge-estado badge-estado-activo">Habilitado</span>
                                        <span class="badge-bloqueado">Bloqueado</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-dark-custom table-striped table-hover align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th scope="col">ID</th>
                                        <th scope="col">Nombre</th>
                                        <th scope="col">Estado</th>
                                        <th scope="col">Préstamos activos</th>
                                        <th scope="col">Préstamos vencidos</th>
                                        <th scope="col">Total devueltos</th>
                                        <th scope="col">Días de bloqueo</th>
                                        <th scope="col">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Iteración sobre lectores paginados -->
                                    <tr th:each="lector : ${paginaLectores?.contenido ?: lectores}" 
                                        th:if="${(paginaLectores?.contenido ?: lectores) != null and !(paginaLectores?.contenido ?: lectores).empty}">
                                        <td>
                                            <span class="small" th:text="${lector.idLector}">102</span>
                                        </td>
                                        <td>
                                            <div class="fw-semibold d-flex align-items-center gap-1">
                                                <span th:text="${lector.nombreCompleto}">Juan Pérez</span>
                                                <span th:if="${lector.bloqueado}" class="badge-bloqueado">
                                                    Bloqueado
                                                </span>
                                            </div>
                                        </td>
                                        <td>
                                            <span th:if="${!lector.bloqueado}" class="badge-estado badge-estado-activo">Habilitado</span>
                                            <span th:if="${lector.bloqueado}" class="badge-bloqueado">Bloqueado</span>
                                        </td>
                                        <td>
                                            <span class="small" th:text="${lector.prestamosActivos ?: 0}">0</span>
                                        </td>
                                        <td>
                                            <span class="small" th:text="${lector.prestamosVencidos ?: 0}">0</span>
                                        </td>
                                        <td>
                                            <span class="small" th:text="${lector.totalDevueltos ?: 0}">0</span>
                                        </td>
                                        <td>
                                            <span class="small" th:text="${lector.diasBloqueo ?: 0}">0</span>
                                        </td>
                                        <td>
                                            <a th:href="@{/bibliotecario/lectores/{id}(id=${lector.idLector})}"
                                                class="btn btn-outline-secondary btn-sm">
                                                <i class="bi bi-eye me-1"></i>
                                                Ver detalle
                                            </a>
                                        </td>
                                    </tr>

                                    <!-- Mensaje cuando no hay datos -->
                                    <tr th:if="${(paginaLectores?.contenido ?: lectores) == null or (paginaLectores?.contenido ?: lectores).empty}">
                                        <td colspan="8" class="text-center py-4">
                                            <div class="text-soft-muted">
                                                <i class="bi bi-people h3 d-block mb-2"></i>
                                                <p class="mb-0" th:if="${estadoFiltro != null}">
                                                    No hay lectores en estado <strong th:text="${estadoFiltro}">filtrado</strong>.
                                                </p>
                                                <p class="mb-0" th:unless="${estadoFiltro != null}">
                                                    No hay lectores registrados en el sistema.
                                                </p>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginación si es necesaria -->
                        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-4 gap-3" 
                             th:if="${paginaLectores != null and paginaLectores.totalPaginas > 1}">
                            <!-- Info de página actual -->
                            <div class="pagination-info text-center text-md-start">
                                <span th:text="'Página ' + ${paginaLectores.numeroPagina + 1} + ' de ' + ${paginaLectores.totalPaginas}">
                                    Página 1 de 1
                                </span>
                            </div>

                            <!-- Controles de paginación -->
                            <div class="d-flex pagination-controls">
                                <!-- Primera página -->
                                <a th:href="@{/bibliotecario/lectores(pagina=0, tamano=${paginaLectores.tamanoPagina}, estado=${estadoFiltro})}"
                                   th:class="'btn btn-outline-secondary btn-sm' + ${paginaLectores.numeroPagina == 0 ? ' disabled' : ''}"
                                   th:classappend="${paginaLectores.numeroPagina == 0 ? ' pe-none' : ''}"
                                   title="Primera página">
                                    <i class="bi bi-chevron-double-left"></i>
                                </a>

                                <!-- Página anterior -->
                                <a th:href="@{/bibliotecario/lectores(pagina=${paginaLectores.numeroPagina - 1}, tamano=${paginaLectores.tamanoPagina}, estado=${estadoFiltro})}"
                                   th:class="'btn btn-outline-secondary btn-sm' + ${paginaLectores.numeroPagina == 0 ? ' disabled' : ''}"
                                   th:classappend="${paginaLectores.numeroPagina == 0 ? ' pe-none' : ''}"
                                   title="Página anterior">
                                    <i class="bi bi-chevron-left"></i>
                                </a>

                                <!-- Números de página -->
                                <th:block th:each="pageNum : ${#numbers.sequence(T(java.lang.Math).max(0, paginaLectores.numeroPagina - 2), 
                                                                T(java.lang.Math).min(paginaLectores.totalPaginas - 1, paginaLectores.numeroPagina + 2))}">
                                    <a th:href="@{/bibliotecario/lectores(pagina=${pageNum}, tamano=${paginaLectores.tamanoPagina}, estado=${estadoFiltro})}"
                                       th:class="'btn btn-sm' + ${pageNum == paginaLectores.numeroPagina ? ' btn-primary' : ' btn-outline-secondary'}"
                                       th:text="${pageNum + 1}">1</a>
                                </th:block>

                                <!-- Página siguiente -->
                                <a th:href="@{/bibliotecario/lectores(pagina=${paginaLectores.numeroPagina + 1}, tamano=${paginaLectores.tamanoPagina}, estado=${estadoFiltro})}"
                                   th:class="'btn btn-outline-secondary btn-sm' + ${paginaLectores.numeroPagina >= paginaLectores.totalPaginas - 1 ? ' disabled' : ''}"
                                   th:classappend="${paginaLectores.numeroPagina >= paginaLectores.totalPaginas - 1 ? ' pe-none' : ''}"
                                   title="Página siguiente">
                                    <i class="bi bi-chevron-right"></i>
                                </a>

                                <!-- Última página -->
                                <a th:href="@{/bibliotecario/lectores(pagina=${paginaLectores.totalPaginas - 1}, tamano=${paginaLectores.tamanoPagina}, estado=${estadoFiltro})}"
                                   th:class="'btn btn-outline-secondary btn-sm' + ${paginaLectores.numeroPagina >= paginaLectores.totalPaginas - 1 ? ' disabled' : ''}"
                                   th:classappend="${paginaLectores.numeroPagina >= paginaLectores.totalPaginas - 1 ? ' pe-none' : ''}"
                                   title="Última página">
                                    <i class="bi bi-chevron-double-right"></i>
                                </a>
                            </div>

                            <!-- Selector de tamaño de página -->
                            <form method="get" class="page-size-selector">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">Por página:</span>
                                    <select name="tamano" class="form-select" onchange="this.form.submit()">
                                        <option value="10" th:selected="${paginaLectores.tamanoPagina == 10}">10</option>
                                        <option value="20" th:selected="${paginaLectores.tamanoPagina == 20}">20</option>
                                        <option value="50" th:selected="${paginaLectores.tamanoPagina == 50}">50</option>
                                        <option value="100" th:selected="${paginaLectores.tamanoPagina == 100}">100</option>
                                    </select>
                                    <input type="hidden" name="pagina" value="0">
                                    <input type="hidden" name="estado" th:value="${estadoFiltro}">
                                </div>
                            </form>
                        </div>

                        <!-- Mensaje cuando solo hay una página -->
                        <div class="text-center mt-3" th:if="${paginaLectores != null and paginaLectores.totalPaginas <= 1}">
                            <small class="text-soft-muted">
                                <span th:if="${paginaLectores.totalElementos == 0 and estadoFiltro == null}">No hay lectores registrados</span>
                                <span th:if="${paginaLectores.totalElementos == 0 and estadoFiltro != null}">
                                    No hay lectores en estado <strong th:text="${estadoFiltro}">filtrado</strong>
                                </span>
                                <span th:if="${paginaLectores.totalElementos > 0 and paginaLectores.totalElementos <= paginaLectores.tamanoPagina}">
                                    Mostrando todos los <span th:text="${paginaLectores.totalElementos}">0</span> lectores
                                    <span th:if="${estadoFiltro != null}"> en estado <strong th:text="${estadoFiltro}">filtrado</strong></span>
                                </span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>